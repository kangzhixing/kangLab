<#import "../main.html" as page>
<@page.main current="/dbDoc" title="Json格式化">
<style type="text/css">
    textarea {
        min-height: 60vh;
        outline: none;
        border: none;
        width: 95%;
        margin-bottom: 50px;
        resize: none;
    }

    .waring{
        box-shadow:0 0 10px lightcoral;
    }
</style>

<div id="pageMSSQL" class="divPage">
    <div class="divTitleText"></div>
    <div class="divCondition">
        <div>
            <button id="btnFormat" class="jk-button mr10">格式化</button>
            <button id="btnClear" onclick="$('#divDatas').val('')" class="jk-button mr10">清空</button>
        </div>
    </div>
    <textarea id="divDatas" class="divContent" placeholder="输入原字符串"></textarea>
</div>
<script type="text/javascript">

    $(function () {
        $("#divDatas").focus();
    });
    $("#btnFormat").bind("click", function () {
        if ($("#divDatas").val()) {
            try {
                var jsonStr = formatJson($("#divDatas").val());
                $("#divDatas").removeClass("waring");
                $("#divDatas").val(jsonStr);
            } catch (e) {
                $("#divDatas").addClass("waring");
            }

        }
    });
    // 工具方法
    var formatJson = function (json, options) {
        var reg,
            formatted = '',
            pad = 0,
            PADDING = '    '; // one can also use '\t' or a different number of spaces
        // optional settings
        options = options || {};
        // remove newline where '{' or '[' follows ':'
        options.newlineAfterColonIfBeforeBraceOrBracket = (options.newlineAfterColonIfBeforeBraceOrBracket === true) ? true : false;
        // use a space after a colon
        options.spaceAfterColon = (options.spaceAfterColon === false) ? false : true;

        // begin formatting...

        // make sure we start with the JSON as a string
        if (typeof json !== 'string') {
            json = JSON.stringify(json);
        }
        // parse and stringify in order to remove extra whitespace
        json = JSON.parse(json);
        json = JSON.stringify(json);

        // add newline before and after curly braces
        reg = /([\{\}])/g;
        json = json.replace(reg, '\r\n$1\r\n');

        // add newline before and after square brackets
        reg = /([\[\]])/g;
        json = json.replace(reg, '\r\n$1\r\n');

        // add newline after comma
        reg = /(\,)/g;
        json = json.replace(reg, '$1\r\n');

        // remove multiple newlines
        reg = /(\r\n\r\n)/g;
        json = json.replace(reg, '\r\n');

        // remove newlines before commas
        reg = /\r\n\,/g;
        json = json.replace(reg, ',');

        // optional formatting...
        if (!options.newlineAfterColonIfBeforeBraceOrBracket) {
            reg = /\:\r\n\{/g;
            json = json.replace(reg, ':{');
            reg = /\:\r\n\[/g;
            json = json.replace(reg, ':[');
        }
        if (options.spaceAfterColon) {
            reg = /\:/g;
            json = json.replace(reg, ': ');
        }

        $.each(json.split('\r\n'), function (index, node) {
            var i = 0,
                indent = 0,
                padding = '';

            if (node.match(/\{$/) || node.match(/\[$/)) {
                indent = 1;
            } else if (node.match(/\}/) || node.match(/\]/)) {
                if (pad !== 0) {
                    pad -= 1;
                }
            } else {
                indent = 0;
            }

            for (i = 0; i < pad; i++) {
                padding += PADDING;
            }
            formatted += padding + node + '\r\n';
            pad += indent;
        });
        return formatted;
    };
</script>

</@page.main>